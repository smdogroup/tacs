
<!DOCTYPE html>

<html lang="python">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>CRM Optimization &#8212; TACS  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxdoc.css" />
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TACS  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CRM Optimization</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="crm-optimization">
<h1>CRM Optimization<a class="headerlink" href="#crm-optimization" title="Permalink to this heading">Â¶</a></h1>
<p>Listed below is a demonstration of a simple optimization problem in
TACS: minimize the mass of the CRM model subject to a global stress
aggregate constraint enforcing that the maximum stress at any
quadrature point is less than a specified upper bound.</p>
<p>First, import required libraries:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">tacs</span> <span class="kn">import</span> <span class="n">TACS</span><span class="p">,</span> <span class="n">elements</span><span class="p">,</span> <span class="n">constitutive</span><span class="p">,</span> <span class="n">functions</span>
<span class="kn">from</span> <span class="nn">paropt</span> <span class="kn">import</span> <span class="n">ParOpt</span>
</pre></div>
</div>
<p>This class will initialize the model in TACS with constitutive
properties and design variables, then generate the ParOpt
problem to be optimized.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">uCRM_VonMisesMassMin</span><span class="p">(</span><span class="n">ParOpt</span><span class="o">.</span><span class="n">pyParOptProblem</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">bdf_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">comm</span>
        <span class="c1"># Initialize the TACS MeshLoader</span>
        <span class="n">struct_mesh</span> <span class="o">=</span> <span class="n">TACS</span><span class="o">.</span><span class="n">MeshLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
        <span class="c1"># Read in model data from the BDF file</span>
        <span class="n">struct_mesh</span><span class="o">.</span><span class="n">scanBDFFile</span><span class="p">(</span><span class="n">bdf_name</span><span class="p">)</span>

        <span class="c1"># Set constitutive properties</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="mf">2500.0</span> <span class="c1"># density, kg/m^3</span>
        <span class="n">E</span> <span class="o">=</span> <span class="mf">70e9</span> <span class="c1"># elastic modulus, Pa</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="c1"># poisson&#39;s ratio</span>
        <span class="n">kcorr</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="mf">6.0</span> <span class="c1"># shear correction factor</span>
        <span class="n">ys</span> <span class="o">=</span> <span class="mf">350e6</span> <span class="c1"># yield stress, Pa</span>

        <span class="c1"># Set range of thicknesses</span>
        <span class="c1"># These will be the design variables</span>
        <span class="n">min_thickness</span> <span class="o">=</span> <span class="mf">0.002</span>
        <span class="n">max_thickness</span> <span class="o">=</span> <span class="mf">0.20</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="mf">0.02</span>

        <span class="c1"># Loop over components, creating stiffness</span>
        <span class="c1"># and element object for each</span>
        <span class="n">num_components</span> <span class="o">=</span> <span class="n">struct_mesh</span><span class="o">.</span><span class="n">getNumComponents</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_components</span><span class="p">):</span>
            <span class="n">descriptor</span> <span class="o">=</span> <span class="n">struct_mesh</span><span class="o">.</span><span class="n">getElementDescript</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Set the design variable index</span>
            <span class="n">design_variable_index</span> <span class="o">=</span> <span class="n">i</span>
            <span class="c1"># Create the constitutive object</span>
            <span class="c1"># This will contain the properties and design</span>
            <span class="c1"># variables for each element.</span>
            <span class="n">stiff</span> <span class="o">=</span> <span class="n">constitutive</span><span class="o">.</span><span class="n">isoFSDT</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">kcorr</span><span class="p">,</span>
                <span class="n">ys</span><span class="p">,</span> <span class="n">thickness</span><span class="p">,</span> <span class="n">design_variable_index</span><span class="p">,</span>
                <span class="n">min_thickness</span><span class="p">,</span> <span class="n">max_thickness</span><span class="p">)</span>
            <span class="n">element</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Create the element object and assign the</span>
            <span class="c1"># constitutive object</span>
            <span class="k">if</span> <span class="n">descriptor</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;CQUAD&quot;</span><span class="p">,</span> <span class="s2">&quot;CQUADR&quot;</span><span class="p">,</span> <span class="s2">&quot;CQUAD4&quot;</span><span class="p">]:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="n">MITCShell</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">stiff</span><span class="p">,</span>
                        <span class="n">component_num</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># Set the element into the MeshLoader</span>
            <span class="n">struct_mesh</span><span class="o">.</span><span class="n">setElement</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

        <span class="c1"># Create tacs assembler object from mesh loader</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">=</span> <span class="n">struct_mesh</span><span class="o">.</span><span class="n">createTACS</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>

        <span class="c1"># Create the Structural Mass function and KSFailure</span>
        <span class="c1"># function. The structural mass function will be</span>
        <span class="c1"># minimized by the optimizer, with a constraint</span>
        <span class="c1"># on the KSFailure function.</span>
        <span class="n">ksWeight</span> <span class="o">=</span> <span class="mf">50.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">functions</span><span class="o">.</span><span class="n">StructuralMass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="p">),</span>
            <span class="n">functions</span><span class="o">.</span><span class="n">KSFailure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="p">,</span> <span class="n">ksWeight</span><span class="p">)]</span>

        <span class="c1"># Create the forces, apply them with the assembler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">createVec</span><span class="p">()</span>
        <span class="n">force_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">getArray</span><span class="p">()</span>
        <span class="n">force_array</span><span class="p">[</span><span class="mi">2</span><span class="p">::</span><span class="mi">6</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">100.0</span> <span class="c1"># uniform load in z direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">applyBCs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forces</span><span class="p">)</span>

        <span class="c1"># Set up the solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">createVec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">createVec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">createVec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dfdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">createVec</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">createFEMat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">TACS</span><span class="o">.</span><span class="n">Pc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
        <span class="n">subspace</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">restarts</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gmres</span> <span class="o">=</span> <span class="n">TACS</span><span class="o">.</span><span class="n">KSM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">subspace</span><span class="p">,</span> <span class="n">restarts</span><span class="p">)</span>

        <span class="c1"># Scale the mass objective so that it is O(10)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_scale</span> <span class="o">=</span> <span class="mf">1e-3</span>

        <span class="c1"># Scale the thickness variables so that they are measured in</span>
        <span class="c1"># mm rather than meters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thickness_scale</span> <span class="o">=</span> <span class="mf">1000.0</span>

        <span class="c1"># The number of thickness variables in the problem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span> <span class="o">=</span> <span class="n">num_components</span>

        <span class="c1"># The number of constraints (1 global stress constraint that</span>
        <span class="c1"># will use the KS function)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncon</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Initialize the base class - this will run the same problem</span>
        <span class="c1"># on all processors</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">uCRM_VonMisesMassMin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">COMM_SELF</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncon</span><span class="p">)</span>

        <span class="c1"># Set the inequality options for this problem in ParOpt:</span>
        <span class="c1"># The dense constraints are inequalities c(x) &gt;= 0 and</span>
        <span class="c1"># use both the upper/lower bounds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setInequalityOptions</span><span class="p">(</span><span class="n">dense_ineq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">use_lower</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_upper</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For visualization</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">TACS</span><span class="o">.</span><span class="n">ToFH5</span><span class="o">.</span><span class="n">NODES</span> <span class="o">|</span>
                <span class="n">TACS</span><span class="o">.</span><span class="n">ToFH5</span><span class="o">.</span><span class="n">DISPLACEMENTS</span> <span class="o">|</span>
                <span class="n">TACS</span><span class="o">.</span><span class="n">ToFH5</span><span class="o">.</span><span class="n">STRAINS</span> <span class="o">|</span>
                <span class="n">TACS</span><span class="o">.</span><span class="n">ToFH5</span><span class="o">.</span><span class="n">EXTRAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f5</span> <span class="o">=</span> <span class="n">TACS</span><span class="o">.</span><span class="n">ToFH5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="p">,</span> <span class="n">TACS</span><span class="o">.</span><span class="n">PY_SHELL</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span>
</pre></div>
</div>
<p>This function sets the values of the bounds on the design variables</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">getVarsAndBounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">):</span>

    <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">,</span> <span class="n">TACS</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">getDesignVars</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span>
    <span class="n">x</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_scale</span><span class="o">*</span><span class="n">xvals</span>

    <span class="n">xlb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">,</span> <span class="n">TACS</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">xub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">,</span> <span class="n">TACS</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">getDesignVarRange</span><span class="p">(</span><span class="n">xlb</span><span class="p">,</span> <span class="n">xub</span><span class="p">)</span>
    <span class="n">lb</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_scale</span><span class="o">*</span><span class="n">xlb</span>
    <span class="n">ub</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thickness_scale</span><span class="o">*</span><span class="n">xub</span>

    <span class="k">return</span>
</pre></div>
</div>
<p>This function assigns new values to the design variables and then
evaluates the objective and constraint functionals.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evalObjCon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>

    <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">con</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Set the new design variable values</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">setDesignVars</span><span class="p">(</span><span class="n">x</span><span class="p">[:]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness_scale</span><span class="p">)</span>

    <span class="c1"># Assemble the Jacobian and factor the matrix</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">zeroVariables</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">assembleJacobian</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mat</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="o">.</span><span class="n">factor</span><span class="p">()</span>

    <span class="c1"># Solve the linear system and set the varaibles into TACS</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gmres</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forces</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ans</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">setVariables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ans</span><span class="p">)</span>

    <span class="c1"># Evaluate the function</span>
    <span class="n">fvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">evalFunctions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">)</span>

    <span class="c1"># Set the mass as the objective</span>
    <span class="n">fobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_scale</span><span class="o">*</span><span class="n">fvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Set the KS function (the approximate maximum ratio of the</span>
    <span class="c1"># von Mises stress to the design stress) so that</span>
    <span class="c1"># it is less than or equal to 1.0</span>
    <span class="n">con</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">fvals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># ~= 1.0 - max (sigma/design) &gt;= 0</span>

    <span class="k">return</span> <span class="n">fail</span><span class="p">,</span> <span class="n">fobj</span><span class="p">,</span> <span class="n">con</span>
</pre></div>
</div>
<p>This function evaluates the gradients of the objective and constraint
functions with respect to the design variables.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evalObjConGradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>

    <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Evaluate the derivative of the mass and place it in the</span>
    <span class="c1"># objective gradient</span>
    <span class="n">gx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">,</span> <span class="n">TACS</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">evalDVSens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gx</span><span class="p">)</span>
    <span class="n">g</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_scale</span><span class="o">*</span><span class="n">gx</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness_scale</span>

    <span class="c1"># Compute the total derivative w.r.t. material</span>
    <span class="c1"># design variables</span>
    <span class="n">dfdx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">,</span> <span class="n">TACS</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nvars</span><span class="p">,</span> <span class="n">TACS</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Compute the derivative of the function w.r.t. the state</span>
    <span class="c1"># variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">evalDVSens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dfdx</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">evalSVSens</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dfdu</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gmres</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dfdu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjoint</span><span class="p">)</span>

    <span class="c1"># Compute the product of the adjoint with the</span>
    <span class="c1"># derivative of the residuals</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="o">.</span><span class="n">evalAdjointResProduct</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjoint</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>

    <span class="c1"># Set the constraint gradient</span>
    <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">][:]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">dfdx</span> <span class="o">-</span> <span class="n">product</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">thickness_scale</span>

    <span class="c1"># Write out the solution file every 10 iterations</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f5</span><span class="o">.</span><span class="n">writeToFile</span><span class="p">(</span><span class="s1">&#39;ucrm_iter</span><span class="si">%d</span><span class="s1">.f5&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iter_count</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">iter_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">fail</span>
</pre></div>
</div>
<p>Now that the class is defined, initialize it with the desired bdf of
the model and set optimization parameters. Finally, call the
<code class="xref py py-func docutils literal notranslate"><span class="pre">optimize()</span></code> function on the <code class="xref py py-class docutils literal notranslate"><span class="pre">pyParOpt</span></code> problem.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load structural mesh from BDF file</span>
<span class="n">tacs_comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
<span class="n">bdf_name</span> <span class="o">=</span> <span class="s1">&#39;CRM_box_2nd.bdf&#39;</span>

<span class="n">crm_opt</span> <span class="o">=</span> <span class="n">uCRM_VonMisesMassMin</span><span class="p">(</span><span class="n">tacs_comm</span><span class="p">,</span> <span class="n">bdf_name</span><span class="p">)</span>

<span class="c1"># Set up the optimization problem</span>
<span class="n">max_lbfgs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">ParOpt</span><span class="o">.</span><span class="n">pyParOpt</span><span class="p">(</span><span class="n">crm_opt</span><span class="p">,</span> <span class="n">max_lbfgs</span><span class="p">,</span> <span class="n">ParOpt</span><span class="o">.</span><span class="n">BFGS</span><span class="p">)</span>
<span class="n">opt</span><span class="o">.</span><span class="n">setOutputFile</span><span class="p">(</span><span class="s1">&#39;crm_opt.out&#39;</span><span class="p">)</span>

<span class="c1"># Set optimization parameters</span>
<span class="n">opt</span><span class="o">.</span><span class="n">checkGradients</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">)</span>

<span class="c1"># Set optimization parameters</span>
<span class="n">opt</span><span class="o">.</span><span class="n">setArmijoParam</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">)</span>
<span class="n">opt</span><span class="o">.</span><span class="n">optimize</span><span class="p">()</span>

<span class="c1"># Get the optimized point</span>
<span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">zw</span><span class="p">,</span> <span class="n">zl</span><span class="p">,</span> <span class="n">zu</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">getOptimizedPoint</span><span class="p">()</span>
</pre></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">TACS  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CRM Optimization</a></li> 
      </ul>
    </div>
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>

  </body>
</html>